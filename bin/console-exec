#!/usr/bin/env ruby
require 'socket'

HOST = "chomposaur"
PORT = 9001
TIMEOUT = 30

cmd = ARGV.join(" ")

sock = TCPSocket.new(HOST, PORT)
sock.setsockopt(Socket::SOL_SOCKET, Socket::SO_RCVTIMEO, [TIMEOUT, 0].pack("l_2"))

# Send newline to trigger initial prompt
sock.write("\r\n")

# Wait for initial prompt
buf = ""
buf += sock.recv(1024) until buf.end_with?("> ")

# Send command
sock.write("#{cmd}\r\n")

# Read until prompt
response = ""
begin
  response += sock.recv(1024) until response.end_with?("\r\n> ")
rescue
  puts "timeout"
  exit 1
end

# Print response (strip command echo and prompts)
# Response looks like: "\r\n> cmd\r\nresult\r\n> \r\n> "
lines = response.split("\r\n")
# Filter out empty lines, prompt-only lines, and the command echo (with or without prompt prefix)
output = lines.reject { |l| l.empty? || l == "> " || l == ">" || l == cmd || l == "> #{cmd}" }
puts output.join("\n")
sock.close
